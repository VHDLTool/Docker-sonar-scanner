# Description
# ===========
# This workflow is triggered each time the CI workflow succeed
# on develop.
# It looks for the milestone that is completed.
# It must have a title matching the pattern '[0-9]+\.[0-9]+\.[0-9]+'.
# It then merges the develop branch into the master branch
# and tags the master branch with the title of the milestone.
# Finally, it creates a new Release on GitHub where it writes an
# automatically generated changelog.
# It also close the milestone (which is 100% completed).
---
name: CD

# This workflow is triggered when the CI workflow ends
on:
  workflow_run:
    workflows: ["CI"]
    branches: [develop]
    types:
      - completed

# Variables to configure the workflow
env:
  DOCKERFILE_PATH: '.'
  DOCKERFILE_FILENAME: 'Dockerfile'
  DOCKER_IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    name: Release a new version of the docker image
    runs-on: ubuntu-latest
    # The job is run only if the CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get version
        id: version
        run: |
          milestone=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/milestones \
            | jq -r '. | map(select(.open_issues == 0 and .state == "open"))[0]')
          version=$(echo "$milestone" | jq -r '.title')
          milestone_number=$(echo "$milestone" | jq -r '.number')
          echo "::set-output name=version::$version"
          echo "::set-output name=milestone_number::$milestone_number"
      - name: Check milestone title is a version number
        id: test_title
        run: |
          if ! [[ ${{ steps.version.outputs.version }} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
          then
            echo "Malformed milestone name: ${{ steps.version.outputs.version }}. It must match [0-9]+.[0-9]+.[0-9]+"
            exit 1
          fi
      # git clone
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      # Merge develop into master and tag master
      - name: Merge and tag
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email L-lequal@cnes.fr
          git checkout --track origin/master
          git merge --no-ff origin/develop -m "Merge develop for release ${{ steps.version.outputs.version }}"
          git tag -a ${{ steps.version.outputs.version }} \
            -m "Release ${{ steps.version.outputs.version }}"
          git push origin master --follow-tags
      # Get the tag of the last release
      - name: Get tag of last release
        id: last_release
        run: |
          tags=($(git tag --sort="-v:refname" | grep -P -e '[0-9]+\.[0-9]+\.[0-9]+'))
          echo The tag of the previous release is ${tags[1]}
          echo "::set-output name=tag::${tags[1]}"
      # Generate the changelog since last release
      - name: Generate the changelog
        uses: charmixer/auto-changelog-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          since_tag: ${{ steps.last_release.outputs.tag }}
      # Append a link to the image on Docker Hub to the changelog
      - name: Append link to Docker Hub
        run: |
          cat CHANGELOG.md > changelog.md
          echo -e "\nView the image on" \
            "[DockerHub](https://hub.docker.com/r/$DOCKER_IMAGE_NAME)." \
            >> changelog.md
      # Create a new release on GitHub
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Image ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          body_path: changelog.md
      # Close the milestone (that is now 100% completed)
      - name: Close milestone
        run: |
          curl --request PATCH \
            --url https://api.github.com/repos/${GITHUB_REPOSITORY}/milestones/${{ steps.version.outputs.milestone_number }} \
            --header "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data '{"state":"closed"}'
